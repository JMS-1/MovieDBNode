{"version":3,"sources":["../src/database/utils.ts"],"names":[],"mappings":";;AAAA,qCAAkE;AAIlE,6CAAuC;AAEvC,oCAAmC;AAEnC,IAAI,MAA4B,CAAA;AAEhC,SAAS,KAAK,CAAC,EAAU;IACrB,OAAO,IAAI,OAAO,CAAO,OAAO,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAA;AAChE,CAAC;AAEM,KAAK,UAAU,SAAS;IAC3B,QAAS,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE;QACxB,IAAI,CAAC,MAAM,EAAE;YACT,MAAM,GAAG,qBAAW,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,QAAQ,EAAE;gBAC/C,aAAa,EAAE,IAAI;gBACnB,cAAc,EAAE,OAAO;gBACvB,cAAc,EAAE,MAAM,CAAC,SAAS;gBAChC,eAAe,EAAE,IAAI;aACxB,CAAC,CAAA;SACL;QAED,IAAI;YACA,MAAM,MAAM,GAAG,MAAM,MAAM,CAAA;YAE3B,OAAO,MAAM,CAAC,EAAE,EAAE,CAAA;SACrB;QAAC,OAAO,CAAC,EAAE;YACR,MAAM,GAAG,IAAI,CAAA;SAChB;KACJ;AACL,CAAC;AAnBD,8BAmBC;AAED,MAAsB,cAAc;IAApC;QAKa,iBAAY,GAA4B,EAAE,CAAA;IA2DvD,CAAC;IAzDa,aAAa,CAAC,IAAW;QAC/B,IAAI,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;YAC7B,MAAM,IAAI,KAAK,CAAC,0BAA0B,IAAI,CAAC,GAAG,EAAE,CAAC,CAAA;SACxD;QAED,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;IACtC,CAAC;IAED,KAAK,CAAC,aAAa;QACf,MAAM,EAAE,GAAG,MAAM,SAAS,EAAE,CAAA;QAE5B,OAAO,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;IACnC,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,SAAgB;QACzB,IAAI;YACA,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAA;YAErC,MAAM,EAAE,CAAC,SAAS,CAAC,SAAS,CAAC,CAAA;YAE7B,OAAO,SAAS,CAAA;SACnB;QAAC,OAAO,KAAK,EAAE;YACZ,IAAI,KAAK,CAAC,IAAI,KAAK,GAAG,EAAE;gBACpB,MAAM,KAAK,CAAA;aACd;YAED,IAAI;gBACA,OAAO,CACH,qBAAQ,CAAC,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,IAAI;oBAChC;wBACI,SAAS,EAAE,UAAU;wBACrB,OAAO,EAAE,gBAAQ,CAAC,KAAK,CAAC;wBACxB,QAAQ,EAAE,GAAG;qBAChB;iBACJ,CACJ,CAAA;aACJ;YAAC,OAAO,CAAC,EAAE;gBACR,MAAM,KAAK,CAAA;aACd;SACJ;IACL,CAAC;IAED,KAAK,CAAC,KAAK,CAAC,MAA2B,EAAE,IAAa,EAAE,OAAgB;QACpE,MAAM,EAAE,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAA;QAErC,IAAI,KAAK,GAAG,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;QAE3B,IAAI,IAAI,EAAE;YACN,KAAK,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;SAC3B;QAED,IAAI,OAAO,EAAE;YACT,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;SACjC;QAED,OAAO,KAAK,CAAC,OAAO,EAAE,CAAA;IAC1B,CAAC;CACJ;AAhED,wCAgEC","file":"utils.js","sourcesContent":["import { Collection, Db, FilterQuery, MongoClient } from 'mongodb'\n\nimport { IValidatableSchema, IValidationError } from 'movie-db-api'\n\nimport { validate } from './validation'\n\nimport { getError } from '../utils'\n\nlet loader: Promise<MongoClient>\n\nfunction sleep(ms: number): Promise<void> {\n    return new Promise<void>(success => setTimeout(success, ms))\n}\n\nexport async function dbConnect(): Promise<Db> {\n    for (; ; await sleep(5000)) {\n        if (!loader) {\n            loader = MongoClient.connect(process.env.DATABASE, {\n                autoReconnect: true,\n                promiseLibrary: Promise,\n                reconnectTries: Number.MAX_VALUE,\n                useNewUrlParser: true,\n            })\n        }\n\n        try {\n            const client = await loader\n\n            return client.db()\n        } catch (e) {\n            loader = null\n        }\n    }\n}\n\nexport abstract class CollectionBase<TType extends { _id: string }> {\n    abstract readonly name: string\n\n    abstract readonly schema: IValidatableSchema\n\n    readonly migrationMap: { [id: string]: TType } = {}\n\n    protected cacheMigrated(item: TType): void {\n        if (this.migrationMap[item._id]) {\n            throw new Error(`duplicated identifier '${item._id}`)\n        }\n\n        this.migrationMap[item._id] = item\n    }\n\n    async getCollection(): Promise<Collection<TType>> {\n        const db = await dbConnect()\n\n        return db.collection(this.name)\n    }\n\n    async insert(container: TType): Promise<IValidationError[]> {\n        try {\n            const me = await this.getCollection()\n\n            await me.insertOne(container)\n\n            return undefined\n        } catch (error) {\n            if (error.code !== 121) {\n                throw error\n            }\n\n            try {\n                return (\n                    validate(container, this.schema) || [\n                        {\n                            contraint: 'database',\n                            message: getError(error),\n                            property: '*',\n                        },\n                    ]\n                )\n            } catch (e) {\n                throw error\n            }\n        }\n    }\n\n    async query(filter?: FilterQuery<TType>, sort?: object, project?: object): Promise<TType[]> {\n        const me = await this.getCollection()\n\n        let query = me.find(filter)\n\n        if (sort) {\n            query = query.sort(sort)\n        }\n\n        if (project) {\n            query = query.project(project)\n        }\n\n        return query.toArray()\n    }\n}\n"],"sourceRoot":"/home/jochenmanns/Software/git/MovieDBNode/Server/build"}